<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BYD Dolphin Monitor v3.0 - Final Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #005eb8; --bg: #f4f6f8; --accent: #e65100; --expense: #c62828; --save: #2e7d32; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 500px; width: 100%; margin-bottom: 20px; border-top: 5px solid var(--primary); }
        h2 { color: var(--primary); text-align: center; margin-top: 0; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 12px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: none; color: #666; }
        .tab.active { background: white; color: var(--primary); }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; font-size: 0.75em; font-weight: bold; color: #666; margin-bottom: 3px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        .main-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: var(--primary); color: white; font-size: 1rem; margin-top: 10px; }
        .main-btn.editing { background: #fbc02d; color: #333; }
        .btn-cancel { display:none; width:100%; margin-top:5px; padding:10px; border:none; background:#ccc; border-radius:10px; cursor: pointer; }
        .history-card { background: white; width: 100%; max-width: 900px; padding: 15px; border-radius: 16px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: center; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; min-width: 800px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="card">
    <h2>BYD DOLPHIN</h2>
    <div class="tabs">
        <button class="tab active" onclick="openTab('carica')">üîå Ricarica</button>
        <button class="tab" onclick="openTab('stima')">‚è±Ô∏è Stima</button>
    </div>

    <div id="carica" class="form-section active">
        <input type="hidden" id="editIndex" value="-1">
        <div class="grid"><div style="grid-column: span 2;"><label>Data</label><input type="date" id="c_date"></div></div>
        <div class="grid">
            <div><label>Km Totali</label><input type="number" id="c_km"></div>
            <div><label>Potenza kW</label><input type="number" id="c_pKw" step="0.1"></div>
        </div>
        <div class="grid">
            <div><label>% Inizio</label><input type="number" id="c_start_p"></div>
            <div><label>% Fine</label><input type="number" id="c_end_p"></div>
        </div>
        <div class="grid">
            <div><label>Luce ‚Ç¨/kWh</label><input type="number" id="c_pLuce" step="0.001"></div>
            <div><label>Diesel ‚Ç¨/L</label><input type="number" id="c_pDiesel" step="0.001"></div>
        </div>
        <button id="btnSave" class="main-btn" onclick="saveData()">üíæ Salva Ricarica</button>
        <button id="btnCancel" class="btn-cancel" onclick="resetForm()">‚ùå Annulla Modifica</button>
    </div>

    <div id="stima" class="form-section">
        <p style="text-align:center; color:#666;">Usa la tab ricarica per i dati.</p>
    </div>
</div>

<div class="history-card">
    <div class="stats">
        <div class="stat-box"><small>SPESA</small><br><b id="stSpesa" style="color:var(--expense)">‚Ç¨ 0.00</b></div>
        <div class="stat-box"><small>RISPARMIO</small><br><b id="stRisp" style="color:var(--save)">‚Ç¨ 0.00</b></div>
        <div class="stat-box"><small>KM AUTO</small><br><b id="stKm">0</b></div>
    </div>
    <div class="table-wrapper">
        <table>
            <thead><tr><th>Data</th><th>Km</th><th>Carica</th><th>Spesa</th><th>Risparmio</th><th>Azioni</th></tr></thead>
            <tbody id="tabBody"></tbody>
        </table>
    </div>
    <div style="text-align:center; margin-top:20px;">
        <button onclick="exportCSV()" style="background:var(--save); color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">üìä Esporta Backup</button>
    </div>
</div>

<script>
const CONFIG = { cap: 43.2, consTeorico: 15.5, efficienza: 0.86 };
const DB_NAME = 'byd_dolphin_final_v3';

function openTab(id) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(id).classList.add('active');
}

function saveData() {
    const idx = parseInt(document.getElementById('editIndex').value);
    const dateVal = document.getElementById('c_date').value;
    const km = parseFloat(document.getElementById('c_km').value);
    const kw = parseFloat(document.getElementById('c_pKw').value);
    const sP = parseFloat(document.getElementById('c_start_p').value);
    const eP = parseFloat(document.getElementById('c_end_p').value);
    const pL = parseFloat(document.getElementById('c_pLuce').value);
    const pD = parseFloat(document.getElementById('c_pDiesel').value);

    if (isNaN(km) || isNaN(sP) || isNaN(eP) || isNaN(pL) || isNaN(pD)) return alert("Compila tutti i campi!");

    // CALCOLO MATEMATICO (Ricalcolato ogni volta da zero)
    const kwhCaricatiNetti = CONFIG.cap * (eP - sP) / 100;
    const spesaElettrica = (kwhCaricatiNetti / CONFIG.efficienza) * pL;
    // Risparmio = (Litri diesel necessari per fare gli stessi km / 100 * 18km/l) * prezzo diesel - spesa elettrica
    const litriDieselEq = (kwhCaricatiNetti / CONFIG.consTeorico * 100) / 18;
    const risparmioNetto = (litriDieselEq * pD) - spesaElettrica;

    const record = {
        date: dateVal,
        km: km,
        pKw: kw,
        startP: sP,
        endP: eP,
        pLuce: pL,
        pDiesel: pD,
        spesa: spesaElettrica,
        risp: risparmioNetto,
        kwh: kwhCaricatiNetti
    };

    let db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    if (idx > -1) db[idx] = record; else db.push(record);
    
    db.sort((a, b) => new Date(b.date) - new Date(a.date) || b.km - a.km);
    localStorage.setItem(DB_NAME, JSON.stringify(db));
    
    resetForm();
    render();
}

function render() {
    const db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    const body = document.getElementById('tabBody');
    let tS = 0, tR = 0;
    body.innerHTML = '';

    db.forEach((r, i) => {
        tS += r.spesa; tR += r.risp;
        body.innerHTML += `<tr>
            <td>${new Date(r.date).toLocaleDateString('it-IT')}</td>
            <td>${r.km}</td>
            <td>${r.startP}% ‚Üí ${r.endP}%</td>
            <td style="color:var(--expense)">‚Ç¨${r.spesa.toFixed(2)}</td>
            <td style="color:${r.risp >= 0 ? 'var(--save)' : 'var(--expense)'}"><b>‚Ç¨${r.risp.toFixed(2)}</b></td>
            <td><button onclick="editRecord(${i})">‚úèÔ∏è</button> <button onclick="deleteRecord(${i})">üóëÔ∏è</button></td>
        </tr>`;
    });

    document.getElementById('stSpesa').innerText = "‚Ç¨ " + tS.toFixed(2);
    document.getElementById('stRisp').innerText = "‚Ç¨ " + tR.toFixed(2);
    document.getElementById('stKm').innerText = db[0]?.km || 0;
}

function editRecord(i) {
    const r = JSON.parse(localStorage.getItem(DB_NAME))[i];
    document.getElementById('editIndex').value = i;
    document.getElementById('c_date').value = r.date;
    document.getElementById('c_km').value = r.km;
    document.getElementById('c_pKw').value = r.pKw;
    document.getElementById('c_start_p').value = r.startP;
    document.getElementById('c_end_p').value = r.endP;
    document.getElementById('c_pLuce').value = r.pLuce;
    document.getElementById('c_pDiesel').value = r.pDiesel;

    document.getElementById('btnSave').innerText = "üîÑ Aggiorna Record";
    document.getElementById('btnSave').classList.add('editing');
    document.getElementById('btnCancel').style.display = 'block';
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function resetForm() {
    document.getElementById('editIndex').value = "-1";
    document.getElementById('btnSave').innerText = "üíæ Salva Ricarica";
    document.getElementById('btnSave').classList.remove('editing');
    document.getElementById('btnCancel').style.display = 'none';
    document.getElementById('c_date').valueAsDate = new Date();
}

function deleteRecord(i) { if(confirm("Eliminare?")) { let db = JSON.parse(localStorage.getItem(DB_NAME)); db.splice(i,1); localStorage.setItem(DB_NAME, JSON.stringify(db)); render(); } }

function exportCSV() {
    const db = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    let csv = "Data;Km;Inizio;Fine;Spesa;Risparmio;PrezzoLuce;PrezzoDiesel\n";
    db.forEach(r => { csv += `${r.date};${r.km};${r.startP};${r.endP};${r.spesa.toFixed(2)};${r.risp.toFixed(2)};${r.pLuce};${r.pDiesel}\n` });
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "backup_dolphin.csv"; link.click();
}

window.onload = () => {
    document.getElementById('c_date').valueAsDate = new Date();
    document.getElementById('c_pLuce').value = 0.25;
    document.getElementById('c_pDiesel').value = 1.80;
    document.getElementById('c_pKw').value = 2.3;
    render();
};
</script>
</body>
</html>
