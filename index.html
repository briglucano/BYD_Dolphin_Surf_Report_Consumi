function render() {
    const h = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    const tb = document.querySelector('#tabella tbody');
    const annoCorrente = new Date().getFullYear();
    document.getElementById('labelAnnoKwh').innerText = "kWh " + annoCorrente;
    document.getElementById('backupAlert').innerText = "Ultimo Backup: " + (localStorage.getItem('lastBackupDate') || "Mai effettuato");

    let kwhAnno = 0;
    let chartLabels = [], chartDataSpesa = [], chartDataRisp = [];
    let totSpesa = 0, totRisp = 0;
    let totCasa = 0, totCol = 0;
    
    [...h].reverse().forEach(r => { 
        if(r.tipo === 'RICARICA') { 
            totSpesa += r.spesa;
            totRisp += r.risp;
            
            const luogo = r.luogo || 'DOMESTICA';
            if (luogo === 'DOMESTICA') totCasa += r.spesa;
            else totCol += r.spesa;

            chartLabels.push(r.data); 
            chartDataSpesa.push(r.spesa.toFixed(2));
            chartDataRisp.push(r.risp.toFixed(2));

            let a = r.isoDate ? new Date(r.isoDate).getFullYear() : (r.data ? parseInt(r.data.split('/')[2]) : null);
            if (a === annoCorrente) kwhAnno += (r.kwh / CONFIG.efficienza);
        } 
    });
    updateChart(chartLabels, chartDataSpesa, chartDataRisp);

    const limit = showAllHistory ? h.length : 10;
    const visibleData = h.slice(0, limit);
    const btnMore = document.getElementById('btnShowMore');
    
    if(h.length > 10) {
        btnMore.style.display = 'block';
        btnMore.innerText = showAllHistory ? "‚¨ÜÔ∏è Riduci elenco" : "‚¨áÔ∏è Mostra tutto lo storico (" + h.length + ")";
    } else {
        btnMore.style.display = 'none';
    }

    tb.innerHTML = visibleData.map((r, i) => {
        let originalIndex = h.indexOf(r);
        let delta = h[originalIndex+1] ? r.km - h[originalIndex+1].km : 0;
        const pInfo = r.prezzoLuce ? `‚Ç¨${r.prezzoLuce} / ‚Ç¨${r.prezzoDiesel}` : '-';
        const orari = r.t_start ? `${r.t_start}<br>${r.t_end}` : '-';
        
        // Gestione Colore Risparmio (Verde se positivo, Rosso se negativo)
        let colorRisp = 'var(--save)'; // Default verde
        let testoRisp = '-';
        if (r.tipo === 'RICARICA') {
            testoRisp = '‚Ç¨' + r.risp.toFixed(2);
            if (r.risp < 0) colorRisp = 'var(--expense)'; // Diventa rosso (colore spesa)
        }

        let tipoBadge = '';
        if(r.tipo === 'CHECK') {
            tipoBadge = '<span style="background:#6a1b9a; color:white; padding:3px 6px; border-radius:5px; font-size:0.7em;">üìù CHECK</span>';
        } else {
            const icon = (r.luogo === 'COLONNINA') ? '‚õΩ' : 'üè†';
            tipoBadge = `<span style="background:${r.luogo==='COLONNINA'?'#e65100':'#2e7d32'}; color:white; padding:3px 6px; border-radius:5px; font-size:0.7em;">${icon} ${r.luogo}</span>`;
        }
        
        return `
        <tr>
            <td>${r.data}</td>
            <td>${tipoBadge}</td>
            <td><b>${r.km}</b></td>
            <td style="color:var(--accent)">${delta>0?'+'+delta:''}</td>
            <td>${r.batt}</td>
            <td style="font-size:0.8em; color:#555;">${orari}</td>
            <td>${r.tempo || '-'}</td>
            <td style="color:#666; font-size:0.8em;">${pInfo}</td>
            <td style="color:var(--expense)">${r.spesa>0?'‚Ç¨'+r.spesa.toFixed(2):'-'}</td>
            <td style="color:${colorRisp}; font-weight:bold;">${testoRisp}</td>
            <td>
                <button style="border:none; background:none; cursor:pointer; font-size:1.1em;" onclick="preparaModifica(${originalIndex})">‚úèÔ∏è</button>
                <button style="border:none; background:none; color:red; cursor:pointer; font-size:1.1em;" onclick="elimina(${originalIndex})">üóëÔ∏è</button>
            </td>
        </tr>`;
    }).join('');

    // Aggiornamento testate statistiche
    document.getElementById('totSpesa').innerText = "‚Ç¨ " + totSpesa.toFixed(2);
    document.getElementById('totSpesaCasa').innerText = "‚Ç¨ " + totCasa.toFixed(2);
    document.getElementById('totSpesaCol').innerText = "‚Ç¨ " + totCol.toFixed(2);
    
    // Anche il risparmio totale pu√≤ diventare rosso se negativo
    const elTotRisp = document.getElementById('totRisp');
    elTotRisp.innerText = "‚Ç¨ " + totRisp.toFixed(2);
    elTotRisp.style.color = totRisp >= 0 ? 'var(--save)' : 'var(--expense)';

    document.getElementById('totKwhAnno').innerText = kwhAnno.toFixed(1);
    document.getElementById('totKmReali').innerText = h[0]?.km || 0;
    
    // Ricalcolo Consumo Medio (omesso per brevit√†, rimane uguale a prima)
    // ...
}
