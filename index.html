<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BYD Dolphin Monitor Pro v2.4 - FIXED</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #005eb8; --bg: #f4f6f8; --accent: #e65100; --expense: #c62828; --check: #6a1b9a; --consumption: #00838f; --excel: #1d6f42; --edit: #fbc02d; --save: #2e7d32; }
        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 15px; color: #333; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 550px; width: 100%; margin-bottom: 20px; border-top: 5px solid var(--primary); box-sizing: border-box; }
        h2 { color: var(--primary); text-align: center; margin: 0; font-size: 1.4rem; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #eee; padding: 5px; border-radius: 12px; }
        .tab { flex: 1; padding: 12px 5px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: none; color: #666; font-size: 0.8em; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.75em; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        .radio-group { display: flex; gap: 10px; background: #f9f9f9; padding: 5px; border-radius: 10px; border: 1px solid #ddd; }
        .radio-label { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-size: 0.9em; font-weight: bold; }
        .radio-label input { display: none; }
        .radio-label:has(input:checked) { background: var(--primary); color: white; }
        .power-box { background: #fffde7; padding: 12px; border-radius: 12px; border: 1px solid #fbc02d; margin-bottom: 10px; }
        button.main-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; background: var(--primary); color: white; }
        button.main-btn.editing { background: var(--edit); color: #333; }
        .btn-cancel { display:none; width:100%; margin-top:5px; padding:10px; border:none; background:#ccc; border-radius:10px; font-weight:bold; cursor: pointer; }
        .history-card { background: white; width: 100%; max-width: 1000px; padding: 15px; border-radius: 16px; box-sizing: border-box; }
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 15px; }
        .stat-small { background: #fff; padding: 10px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; min-width: 900px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="card">
    <h2>BYD DOLPHIN</h2>
    <div class="tabs">
        <button class="tab active" onclick="openTab('stima')">Stima</button>
        <button class="tab" onclick="openTab('carica')">Ricarica</button>
        <button class="tab" onclick="openTab('check')">Check</button>
    </div>

    <div id="carica" class="form-section">
        <input type="hidden" id="editIndex" value="-1">
        <div class="grid">
            <div style="grid-column: span 2;"><label>Data</label><input type="date" id="data_inserimento"></div>
        </div>
        <div class="grid">
            <div style="grid-column: span 2;">
                <label>Luogo</label>
                <div class="radio-group">
                    <label class="radio-label"><input type="radio" name="luogoRicarica" value="DOMESTICA" checked> üè† Casa</label>
                    <label class="radio-label"><input type="radio" name="luogoRicarica" value="COLONNINA"> ‚õΩ Colonnina</label>
                </div>
            </div>
        </div>
        <div class="grid"><div><label>Km</label><input type="number" id="kmOdo"></div><div><label>Potenza kW</label><input type="number" id="pKw_carica" step="0.1"></div></div>
        <div class="grid"><div><label>% Inizio</label><input type="number" id="c_att"></div><div><label>% Fine</label><input type="number" id="c_tar"></div></div>
        <div class="grid"><div><label>Ora Inizio</label><input type="time" id="t_start"></div><div><label>Ora Fine</label><input type="time" id="t_end"></div></div>
        <div class="grid"><div><label>Luce ‚Ç¨/kWh</label><input type="number" id="pLuce" step="0.001"></div><div><label>Diesel ‚Ç¨/L</label><input type="number" id="pDiesel" step="0.001"></div></div>
        <button id="btnSalva" class="main-btn" onclick="salvaRicarica()">üíæ Salva Ricarica</button>
        <button id="btnAnnulla" class="btn-cancel" onclick="annullaModifica()">‚ùå Annulla</button>
    </div>

    <div id="stima" class="form-section active"><p style="text-align:center">Usa la tab ricarica per inserire i dati.</p></div>
    <div id="check" class="form-section">
         <input type="hidden" id="editCheckIndex" value="-1">
         <div class="grid"><div><label>Km</label><input type="number" id="chk_km"></div><div><label>% Batteria</label><input type="number" id="chk_perc"></div></div>
         <button id="btnSalvaCheck" class="main-btn" style="background:var(--check)" onclick="salvaCheck()">üìù Registra Stato</button>
    </div>
</div>

<div class="history-card">
    <div class="stats-summary">
        <div class="stat-small"><small>SPESA</small><br><b id="totSpesa">‚Ç¨ 0.00</b></div>
        <div class="stat-small"><small>RISPARMIO</small><br><b id="totRisp">‚Ç¨ 0.00</b></div>
        <div class="stat-small"><small>KM</small><br><b id="totKmReali">0</b></div>
    </div>
    <div class="table-wrapper">
        <table id="tabella">
            <thead><tr><th>Data</th><th>Km</th><th>Carica</th><th>Spesa</th><th>Risparmio</th><th>Azioni</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <div style="margin-top:20px; text-align:center;">
        <button onclick="esportaExcel()" style="background:var(--excel); color:white; border:none; padding:10px; border-radius:8px;">üìä Esporta Backup</button>
        <button onclick="document.getElementById('fileInput').click()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:8px;">üì• Importa Backup</button>
        <input type="file" id="fileInput" style="display:none" accept=".csv" onchange="importaCSV(event)">
    </div>
</div>

<script>
const CONFIG = { cap: 43.2, consTeorico: 15.5, efficienza: 0.86 };
const DB_NAME = 'ev_byd_v25_final';

function openTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(name).classList.add('active');
}

function salvaRicarica() {
    const idx = parseInt(document.getElementById('editIndex').value);
    const dataIn = document.getElementById('data_inserimento').valueAsDate || new Date();
    const att = parseFloat(document.getElementById('c_att').value);
    const tar = parseFloat(document.getElementById('c_tar').value);
    const km = parseFloat(document.getElementById('kmOdo').value);
    const pL = parseFloat(document.getElementById('pLuce').value);
    const pD = parseFloat(document.getElementById('pDiesel').value);
    const pKw = document.getElementById('pKw_carica').value;
    const luogo = document.querySelector('input[name="luogoRicarica"]:checked').value;

    if (isNaN(km) || isNaN(att) || isNaN(tar) || isNaN(pL) || isNaN(pD)) return alert("Controlla i dati!");

    const kwhNetti = CONFIG.cap * (tar - att) / 100;
    const spesa = (kwhNetti / CONFIG.efficienza) * pL;
    const risp = (((kwhNetti / CONFIG.consTeorico) * 100) / 18 * pD) - spesa;

    const record = {
        tipo: 'RICARICA', luogo: luogo, isoDate: dataIn.toISOString(), data: dataIn.toLocaleDateString('it-IT'),
        km: km, batt: att + "%‚Üí" + tar + "%", c_att: att, c_tar: tar, 
        t_start: document.getElementById('t_start').value, t_end: document.getElementById('t_end').value,
        prezzoLuce: pL, prezzoDiesel: pD, pKw: pKw, spesa: spesa, risp: risp, kwh: kwhNetti
    };

    let h = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    if (idx > -1) h[idx] = record; else h.push(record);
    
    h.sort((a, b) => b.km - a.km);
    localStorage.setItem(DB_NAME, JSON.stringify(h));
    render();
    annullaModifica();
}

function preparaModifica(index) {
    const h = JSON.parse(localStorage.getItem(DB_NAME));
    const r = h[index];
    
    if (r.tipo === 'RICARICA') {
        openTab('carica');
        document.getElementById('editIndex').value = index;
        document.getElementById('data_inserimento').value = r.isoDate.split('T')[0];
        document.getElementById('kmOdo').value = r.km;
        document.getElementById('c_att').value = r.c_att;
        document.getElementById('c_tar').value = r.c_tar;
        document.getElementById('pLuce').value = r.prezzoLuce;
        document.getElementById('pDiesel').value = r.prezzoDiesel;
        document.getElementById('pKw_carica').value = r.pKw || 2.3;
        document.getElementById('t_start').value = r.t_start || "";
        document.getElementById('t_end').value = r.t_end || "";
        document.querySelector(`input[name="luogoRicarica"][value="${r.luogo || 'DOMESTICA'}"]`).checked = true;
        
        document.getElementById('btnSalva').innerText = "üîÑ Aggiorna Record";
        document.getElementById('btnSalva').classList.add('editing');
        document.getElementById('btnAnnulla').style.display = 'block';
    }
}

function render() {
    const h = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    const tb = document.querySelector('#tabella tbody');
    let tSpesa = 0, tRisp = 0;

    tb.innerHTML = h.map((r, i) => {
        if(r.tipo === 'RICARICA') { tSpesa += r.spesa; tRisp += r.risp; }
        return `<tr>
            <td>${r.data}</td>
            <td>${r.km}</td>
            <td>${r.batt}</td>
            <td>‚Ç¨${r.spesa.toFixed(2)}</td>
            <td style="color:${r.risp > 0 ? 'green' : 'red'}"><b>‚Ç¨${r.risp.toFixed(2)}</b></td>
            <td><button onclick="preparaModifica(${i})">‚úèÔ∏è</button> <button onclick="elimina(${i})">üóëÔ∏è</button></td>
        </tr>`;
    }).join('');

    document.getElementById('totSpesa').innerText = "‚Ç¨ " + tSpesa.toFixed(2);
    document.getElementById('totRisp').innerText = "‚Ç¨ " + tRisp.toFixed(2);
    document.getElementById('totKmReali').innerText = h[0]?.km || 0;
}

function annullaModifica() {
    document.getElementById('editIndex').value = "-1";
    document.getElementById('btnSalva').innerText = "üíæ Salva Ricarica";
    document.getElementById('btnSalva').classList.remove('editing');
    document.getElementById('btnAnnulla').style.display = 'none';
    document.getElementById('kmOdo').value = "";
}

function elimina(i) { if(confirm("Eliminare?")) { let h = JSON.parse(localStorage.getItem(DB_NAME)); h.splice(i,1); localStorage.setItem(DB_NAME, JSON.stringify(h)); render(); } }

function esportaExcel() {
    const h = JSON.parse(localStorage.getItem(DB_NAME)) || [];
    let csv = "Data;Tipo;Luogo;Km;Batt;Inizio;Fine;Spesa;Risp;Kwh;PrezzoLuce;PrezzoDiesel;IsoDate\n";
    h.forEach(r => { csv += `${r.data};${r.tipo};${r.luogo};${r.km};${r.batt};${r.t_start};${r.t_end};${r.spesa};${r.risp};${r.kwh};${r.prezzoLuce};${r.prezzoDiesel};${r.isoDate}\n` });
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    link.download = `backup_dolphin.csv`; link.click();
}

function importaCSV(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const rows = event.target.result.split('\n');
        let data = [];
        for(let i=1; i<rows.length; i++) {
            const c = rows[i].split(';'); if(c.length < 10) continue;
            data.push({ data: c[0], tipo: c[1], luogo: c[2], km: parseFloat(c[3]), batt: c[4], t_start: c[5], t_end: c[6], spesa: parseFloat(c[7]), risp: parseFloat(c[8]), kwh: parseFloat(c[9]), prezzoLuce: parseFloat(c[10]), prezzoDiesel: parseFloat(c[11]), isoDate: c[12] });
        }
        localStorage.setItem(DB_NAME, JSON.stringify(data)); render();
    };
    reader.readAsText(e.target.files[0]);
}

window.onload = render;
</script>
</body>
</html>
